package org.opentestsystem.delivery.logging;

import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.delivery.logging.EventLogger.IEventData;
import org.opentestsystem.delivery.logging.EventLogger.ILogEvent;

import javax.servlet.http.HttpServletRequest;

import java.util.HashMap;
import java.util.Map;

import static org.opentestsystem.delivery.logging.EventLogger.LogEvent.UNKNOWN;
import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorEventData.ASSESSMENTS;
import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorLogEvent.ADD_ASSESSMENTS;
import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorLogEvent.START_SESSION;

public class ProctorEventParserFactory implements EventParserFactory {

    @Override
    public EventParser get(HttpServletRequest request) {
        final String path = request.getRequestURL().toString();


        if (path.contains("InsertSessionTests")) {
            final String strSessionKey = request.getParameter("sessionKey");
            final String testIDs = request.getParameter("testIDs");

            if (StringUtils.isEmpty(strSessionKey)) {
                return new StartSessionParser(testIDs);
            } else {
                return new AddAssessmentParser(testIDs);
            }
        }

        return new EventParserAdaptor(UNKNOWN);
    }

    class AssessmentParser extends EventParserAdaptor {
        final String assessments;

        public AssessmentParser(final ILogEvent event, final String assessments) {
            super(event);
            this.assessments = assessments;
        }

        Map<IEventData, Object> preHandleFields(HttpServletRequest request) {
            final Map<IEventData, Object> fields = new HashMap<>();
            fields.put(ASSESSMENTS, assessments);
            return fields;
        }

    }

    class StartSessionParser extends AssessmentParser {
        public StartSessionParser(final String assessments) {
            super(START_SESSION, assessments);
        }
    }

    class AddAssessmentParser extends AssessmentParser {
        public AddAssessmentParser(final String assessments) {
            super(ADD_ASSESSMENTS, assessments);
        }

    }
}
