/***************************************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2017 Regents of the University of California
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 *
 * SmarterApp Open Source Assessment Software Project: http://smarterapp.org
 * Developed by Fairway Technologies, Inc. (http://fairwaytech.com)
 * for the Smarter Balanced Assessment Consortium (http://smarterbalanced.org)
 **************************************************************************************************/

package org.opentestsystem.delivery.logging;

import TDS.Proctor.Sql.Data.ProctorUser;
import TDS.Proctor.Web.Handlers.ActiveSessionXHR;
import com.google.common.base.Optional;
import org.springframework.web.method.HandlerMethod;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.HashMap;
import java.util.Map;

import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorEventData.BROWSER_ID;
import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorEventData.PROCTOR_ID;
import static org.opentestsystem.delivery.logging.ProctorEventLogger.ProctorEventData.SESSION_ID;

public class ProctorEventParserFactory extends EventParserFactory {

  private static final Map<String, Class<? extends EventParser>> classMap = new HashMap<>();

  static {
    classMap.put("*", ProctorParser.class);
  }

  @Override
  protected Map<String, Class<? extends EventParser>> getEventParserClassMap() {
    return classMap;
  }
}

class ProctorParser extends EventParser {
  public Map<EventLogger.EventData, Object> getEventDataFields(final HttpServletRequest request, final Object handler) {
    final Map<EventLogger.EventData, Object> fields = getEventDataFields(request);

    if (handler != null && handler instanceof HandlerMethod) {
      final HandlerMethod handlerMethod = (HandlerMethod) handler;
      if (handlerMethod.getBean() != null && handlerMethod.getBean() instanceof ActiveSessionXHR) {
        final ActiveSessionXHR activeSessionXHR = (ActiveSessionXHR)handlerMethod.getBean();
        final ProctorUser proctorUser = activeSessionXHR.getUser();
        if (proctorUser != null) {
          fields.put(PROCTOR_ID, proctorUser.getId());
          fields.put(SESSION_ID, proctorUser.getSessionKey());
          fields.put(BROWSER_ID, proctorUser.getBrowserKey());
        }
      }
    }
    return fields;
  }

  @Override
  public Optional<EventInfo> parsePreHandle(final HttpServletRequest request, final Object handler, final EventLogger logger) {
    return Optional.of(EventInfo.builder().event(request.getRequestURI()).data(getEventDataFields(request, handler)).build());
  }

  @Override
  public Optional<EventInfo> parsePostHandle(final HttpServletRequest request, final HttpServletResponse response, final Object handler,
                                             final EventLogger logger) {
    return parsePreHandle(request, handler, logger);
  }
}
